name: appium-android

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: macos-latest # the machine type
    strategy: # we are using strategy if we need to run on parallel with different devices and version
      matrix:
        api-level: [30] # Google API level, for example [25, 23, 28] 
        target: [default]
    steps:
      - uses: actions/checkout@v2 # Checkout the code

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Install dependencies
        run: |
          brew tap homebrew/cask
          brew install --cask android-sdk
          echo "export ANDROID_HOME=/usr/local/share/android-sdk" >> $GITHUB_ENV
          echo "export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV

      - name: Install Android SDK packages
        run: |
          sdkmanager "platform-tools" "platforms;android-${{ matrix.api-level }}" "emulator"

      - name: Install and Run Appium Server
        run: |
          npm install -g appium@1.20.2
          appium -v
          nohup appium &>/dev/null &

      - name: Start Emulator
        run: |
          $ANDROID_HOME/emulator/emulator -avd Nexus_6_API_${{ matrix.api-level }} -no-audio -no-boot-anim -gpu auto -qemu -m 2048 &
          adb wait-for-device
          adb shell input keyevent 82

      - name: Wait for emulator to be ready
        run: |
          adb wait-for-device
          adb shell getprop init.svc.bootanim | grep -m 1 stopped

      - name: Run Appium Tests
        run: mvn clean test -Pandroid # Running our test with info to check the results
